<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콘서트홀 리버브 효과 MP3 재생기</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 30px;
            background-color: #f5f5f5;
        }
        input, button {
            font-size: 16px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>🎵 콘서트홀 리버브 효과 MP3 재생기</h1>
    <input type="file" id="audioFileInput" accept="audio/mp3" />
    <br>
    <button onclick="playWithReverb()">Reverb 재생</button>

    <script>
        let audioContext;
        let audioBuffer;
        let convolverBuffer;

        // 콘서트홀 느낌의 임펄스 응답 파일 URL (공개 샘플)
        const impulseUrl = 'https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/audio-basics/impulse-responses/matrix-reverb2.wav';

        // 사용자 MP3 파일 로딩
        document.getElementById('audioFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContext.decodeAudioData(arrayBuffer, function(buffer) {
                    audioBuffer = buffer;
                    console.log("MP3 파일 로드 완료");
                });
            };
            reader.readAsArrayBuffer(file);
        });

        // 리버브용 임펄스 응답 로드
        function loadImpulseResponse(callback) {
            fetch(impulseUrl)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(buffer => {
                    convolverBuffer = buffer;
                    console.log("리버브 임펄스 로드 완료");
                    if (callback) callback();
                })
                .catch(err => console.error("임펄스 로드 실패:", err));
        }

        // 재생 함수
        function playWithReverb() {
            if (!audioBuffer) {
                alert("먼저 MP3 파일을 선택하세요.");
                return;
            }

            if (!convolverBuffer) {
                alert("임펄스 응답이 아직 로드되지 않았습니다.");
                return;
            }

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;

            const convolver = audioContext.createConvolver();
            convolver.buffer = convolverBuffer;

            const gain = audioContext.createGain();
            gain.gain.value = 0.9;

            source.connect(convolver);
            convolver.connect(gain);
            gain.connect(audioContext.destination);

            source.start();
        }

        // 초기화: 임펄스 응답 미리 로딩
        window.onload = () => {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            loadImpulseResponse();
        };
    </script>
</body>
</html>
